---
output:
 pdf_document:
  fig_height: 3
  fig_width: 5
 html_document:
  fig_height: 3
  fig_width: 5
 word_document:
  fig_height: 3
  fig_width: 5
---

## Finding Commanalities Among Baseball Pitchers
### Xander Schwartz   

```{r, setup = TRUE, include = FALSE}
# Do not delete this chunk
library(mosaic)
library(readr)
options(digits = 6)
# load any other necessary packages here
library(tidyr)
library(psych)
library(ggplot2)
library(factoextra)
library(cluster)
library(rpart)
library(DescTools)
library(GGally)
library(baseballr)
library(MVA)
library(stringr)
```

# Data Read In 
```{r eval=FALSE, include=FALSE}
# Pitch By Pitch Savant Data

# storeH2 <- scrape_statcast_savant_batter_all(start_date = "2019-03-20", end_date = "2019-04-04")
# storeH3 <- scrape_statcast_savant_batter_all(start_date = "2019-04-05", end_date = "2019-04-13")
# storeH4 <- scrape_statcast_savant_batter_all(start_date = "2019-04-14", end_date = "2019-04-21")
# storeH5 <- scrape_statcast_savant_batter_all(start_date = "2019-04-22", end_date = "2019-05-01")
# storeH6 <- scrape_statcast_savant_batter_all(start_date = "2019-05-02", end_date = "2019-05-10")
# storeH7 <- scrape_statcast_savant_batter_all(start_date = "2019-05-11", end_date = "2019-05-19")
# storeH8 <- scrape_statcast_savant_batter_all(start_date = "2019-05-20", end_date = "2019-05-28")
# storeH9 <- scrape_statcast_savant_batter_all(start_date = "2019-05-29", end_date = "2019-06-05")
# storeH10 <- scrape_statcast_savant_batter_all(start_date = "2019-06-06", end_date = "2019-06-14")
# storeH11 <- scrape_statcast_savant_batter_all(start_date = "2019-06-15", end_date = "2019-06-23")
# storeH12 <- scrape_statcast_savant_batter_all(start_date = "2019-06-24", end_date = "2019-07-01")
# storeH13 <- scrape_statcast_savant_batter_all(start_date = "2019-07-02", end_date = "2019-07-11")
# storeH14 <- scrape_statcast_savant_batter_all(start_date = "2019-07-12", end_date = "2019-07-20")
# storeH15 <- scrape_statcast_savant_batter_all(start_date = "2019-07-21", end_date = "2019-07-29")
# storeH16 <- scrape_statcast_savant_batter_all(start_date = "2019-07-30", end_date = "2019-08-05")
# storeH17 <- scrape_statcast_savant_batter_all(start_date = "2019-08-06", end_date = "2019-08-14")
# storeH18 <- scrape_statcast_savant_batter_all(start_date = "2019-08-15", end_date = "2019-08-23")
# storeH19 <- scrape_statcast_savant_batter_all(start_date = "2019-08-24", end_date = "2019-09-01")
# storeH20 <- scrape_statcast_savant_batter_all(start_date = "2019-09-02", end_date = "2019-09-10")
# storeH21 <- scrape_statcast_savant_batter_all(start_date = "2019-09-11", end_date = "2019-09-19")
# storeH22 <- scrape_statcast_savant_batter_all(start_date = "2019-09-20", end_date = "2019-09-28")
# storeH23 <- scrape_statcast_savant_batter_all(start_date = "2019-09-29", end_date = "2019-10-05")
#
#  all_pitches19 <- rbind(storeH2, storeH3, storeH4, storeH5, storeH6, storeH7, storeH8,
#                      storeH9, storeH10, storeH11, storeH12, storeH13, storeH14,
#                       storeH15, storeH16, storeH17, storeH18, storeH19, storeH20,
#                       storeH21, storeH22, storeH23)
#
# #Saving the very large dataset so I won't need to run the above code again
#  save(all_pitches19, file = "data/SavantPitch19.rda")
```
```{r eval=FALSE, include=FALSE}
# storeH2 <- scrape_statcast_savant_batter_all(start_date = "2018-03-20", end_date = "2018-04-04")
# storeH3 <- scrape_statcast_savant_batter_all(start_date = "2018-04-05", end_date = "2018-04-13")
# storeH4 <- scrape_statcast_savant_batter_all(start_date = "2018-04-14", end_date = "2018-04-21")
# storeH5 <- scrape_statcast_savant_batter_all(start_date = "2018-04-22", end_date = "2018-05-01")
# storeH6 <- scrape_statcast_savant_batter_all(start_date = "2018-05-02", end_date = "2018-05-10")
# storeH7 <- scrape_statcast_savant_batter_all(start_date = "2018-05-11", end_date = "2018-05-19")
# storeH8 <- scrape_statcast_savant_batter_all(start_date = "2018-05-20", end_date = "2018-05-28")
# storeH9 <- scrape_statcast_savant_batter_all(start_date = "2018-05-29", end_date = "2018-06-05")
# storeH10 <- scrape_statcast_savant_batter_all(start_date = "2018-06-06", end_date = "2018-06-14")
# storeH11 <- scrape_statcast_savant_batter_all(start_date = "2018-06-15", end_date = "2018-06-23")
# storeH12 <- scrape_statcast_savant_batter_all(start_date = "2018-06-24", end_date = "2018-07-01")
# storeH13 <- scrape_statcast_savant_batter_all(start_date = "2018-07-02", end_date = "2018-07-11")
# storeH14 <- scrape_statcast_savant_batter_all(start_date = "2018-07-12", end_date = "2018-07-20")
# storeH15 <- scrape_statcast_savant_batter_all(start_date = "2018-07-21", end_date = "2018-07-29")
# storeH16 <- scrape_statcast_savant_batter_all(start_date = "2018-07-30", end_date = "2018-08-05")
# storeH17 <- scrape_statcast_savant_batter_all(start_date = "2018-08-06", end_date = "2018-08-14")
# storeH18 <- scrape_statcast_savant_batter_all(start_date = "2018-08-15", end_date = "2018-08-23")
# storeH19 <- scrape_statcast_savant_batter_all(start_date = "2018-08-24", end_date = "2018-09-01")
# storeH20 <- scrape_statcast_savant_batter_all(start_date = "2018-09-02", end_date = "2018-09-10")
# storeH21 <- scrape_statcast_savant_batter_all(start_date = "2018-09-11", end_date = "2018-09-19")
# storeH22 <- scrape_statcast_savant_batter_all(start_date = "2018-09-20", end_date = "2018-09-28")
# storeH23 <- scrape_statcast_savant_batter_all(start_date = "2018-09-29", end_date = "2018-10-05")
#
#  all_pitches18 <- rbind(storeH2, storeH3, storeH4, storeH5, storeH6, storeH7, storeH8,
#                      storeH9, storeH10, storeH11, storeH12, storeH13, storeH14,
#                       storeH15, storeH16, storeH17, storeH18, storeH19, storeH20,
#                       storeH21, storeH22, storeH23)
# #Saving the very large dataset so I won't need to run the above code again
#  save(all_pitches18, file = "data/SavantPitch18.rda")
```
```{r eval=FALSE, include=FALSE}
# storeH2 <- scrape_statcast_savant_batter_all(start_date = "2017-03-20", end_date = "2017-04-04")
# storeH3 <- scrape_statcast_savant_batter_all(start_date = "2017-04-05", end_date = "2017-04-13")
# storeH4 <- scrape_statcast_savant_batter_all(start_date = "2017-04-14", end_date = "2017-04-21")
# storeH5 <- scrape_statcast_savant_batter_all(start_date = "2017-04-22", end_date = "2017-05-01")
# storeH6 <- scrape_statcast_savant_batter_all(start_date = "2017-05-02", end_date = "2017-05-10")
# storeH7 <- scrape_statcast_savant_batter_all(start_date = "2017-05-11", end_date = "2017-05-19")
# storeH8 <- scrape_statcast_savant_batter_all(start_date = "2017-05-20", end_date = "2017-05-28")
# storeH9 <- scrape_statcast_savant_batter_all(start_date = "2017-05-29", end_date = "2017-06-05")
# storeH10 <- scrape_statcast_savant_batter_all(start_date = "2017-06-06", end_date = "2017-06-14")
# storeH11 <- scrape_statcast_savant_batter_all(start_date = "2017-06-15", end_date = "2017-06-23")
# storeH12 <- scrape_statcast_savant_batter_all(start_date = "2017-06-24", end_date = "2017-07-01")
# storeH13 <- scrape_statcast_savant_batter_all(start_date = "2017-07-02", end_date = "2017-07-11")
# storeH14 <- scrape_statcast_savant_batter_all(start_date = "2017-07-12", end_date = "2017-07-20")
# storeH15 <- scrape_statcast_savant_batter_all(start_date = "2017-07-21", end_date = "2017-07-29")
# storeH16 <- scrape_statcast_savant_batter_all(start_date = "2017-07-30", end_date = "2017-08-05")
# storeH17 <- scrape_statcast_savant_batter_all(start_date = "2017-08-06", end_date = "2017-08-14")
# storeH18 <- scrape_statcast_savant_batter_all(start_date = "2017-08-15", end_date = "2017-08-23")
# storeH19 <- scrape_statcast_savant_batter_all(start_date = "2017-08-24", end_date = "2017-09-01")
# storeH20 <- scrape_statcast_savant_batter_all(start_date = "2017-09-02", end_date = "2017-09-10")
# storeH21 <- scrape_statcast_savant_batter_all(start_date = "2017-09-11", end_date = "2017-09-19")
# storeH22 <- scrape_statcast_savant_batter_all(start_date = "2017-09-20", end_date = "2017-09-28")
# storeH23 <- scrape_statcast_savant_batter_all(start_date = "2017-09-29", end_date = "2017-10-05")
#
#  all_pitches17 <- rbind(storeH2, storeH3, storeH4, storeH5, storeH6, storeH7, storeH8,
#                      storeH9, storeH10, storeH11, storeH12, storeH13, storeH14,
#                       storeH15, storeH16, storeH17, storeH18, storeH19, storeH20,
#                       storeH21, storeH22, storeH23)
# #Saving the very large dataset so I won't need to run the above code again
#  save(all_pitches17, file = "data/SavantPitch17.rda")
```
```{r eval=FALSE, include=FALSE}
# storeH2 <- scrape_statcast_savant_batter_all(start_date = "2016-03-20", end_date = "2016-04-04")
# storeH3 <- scrape_statcast_savant_batter_all(start_date = "2016-04-05", end_date = "2016-04-13")
# storeH4 <- scrape_statcast_savant_batter_all(start_date = "2016-04-14", end_date = "2016-04-21")
# storeH5 <- scrape_statcast_savant_batter_all(start_date = "2016-04-22", end_date = "2016-05-01")
# storeH6 <- scrape_statcast_savant_batter_all(start_date = "2016-05-02", end_date = "2016-05-10")
# storeH7 <- scrape_statcast_savant_batter_all(start_date = "2016-05-11", end_date = "2016-05-19")
# storeH8 <- scrape_statcast_savant_batter_all(start_date = "2016-05-20", end_date = "2016-05-28")
# storeH9 <- scrape_statcast_savant_batter_all(start_date = "2016-05-29", end_date = "2016-06-05")
# storeH10 <- scrape_statcast_savant_batter_all(start_date = "2016-06-06", end_date = "2016-06-14")
# storeH11 <- scrape_statcast_savant_batter_all(start_date = "2016-06-15", end_date = "2016-06-23")
# storeH12 <- scrape_statcast_savant_batter_all(start_date = "2016-06-24", end_date = "2016-07-01")
# storeH13 <- scrape_statcast_savant_batter_all(start_date = "2016-07-02", end_date = "2016-07-11")
# storeH14 <- scrape_statcast_savant_batter_all(start_date = "2016-07-12", end_date = "2016-07-20")
# storeH15 <- scrape_statcast_savant_batter_all(start_date = "2016-07-21", end_date = "2016-07-29")
# storeH16 <- scrape_statcast_savant_batter_all(start_date = "2016-07-30", end_date = "2016-08-05")
# storeH17 <- scrape_statcast_savant_batter_all(start_date = "2016-08-06", end_date = "2016-08-14")
# storeH18 <- scrape_statcast_savant_batter_all(start_date = "2016-08-15", end_date = "2016-08-23")
# storeH19 <- scrape_statcast_savant_batter_all(start_date = "2016-08-24", end_date = "2016-09-01")
# storeH20 <- scrape_statcast_savant_batter_all(start_date = "2016-09-02", end_date = "2016-09-10")
# storeH21 <- scrape_statcast_savant_batter_all(start_date = "2016-09-11", end_date = "2016-09-19")
# storeH22 <- scrape_statcast_savant_batter_all(start_date = "2016-09-20", end_date = "2016-09-28")
# storeH23 <- scrape_statcast_savant_batter_all(start_date = "2016-09-29", end_date = "2016-10-05")
#
#  all_pitches16 <- rbind(storeH2, storeH3, storeH4, storeH5, storeH6, storeH7, storeH8,
#                      storeH9, storeH10, storeH11, storeH12, storeH13, storeH14,
#                       storeH15, storeH16, storeH17, storeH18, storeH19, storeH20,
#                       storeH21, storeH22, storeH23)
# #Saving the very large dataset so I won't need to run the above code again
#  save(all_pitches16, file = "data/SavantPitch16.rda")
```
```{r eval=FALSE, include=FALSE}
# storeH2 <- scrape_statcast_savant_batter_all(start_date = "2015-03-20", end_date = "2015-04-04")
# storeH3 <- scrape_statcast_savant_batter_all(start_date = "2015-04-05", end_date = "2015-04-13")
# storeH4 <- scrape_statcast_savant_batter_all(start_date = "2015-04-14", end_date = "2015-04-21")
# storeH5 <- scrape_statcast_savant_batter_all(start_date = "2015-04-22", end_date = "2015-05-01")
# storeH6 <- scrape_statcast_savant_batter_all(start_date = "2015-05-02", end_date = "2015-05-10")
# storeH7 <- scrape_statcast_savant_batter_all(start_date = "2015-05-11", end_date = "2015-05-19")
# storeH8 <- scrape_statcast_savant_batter_all(start_date = "2015-05-20", end_date = "2015-05-28")
# storeH9 <- scrape_statcast_savant_batter_all(start_date = "2015-05-29", end_date = "2015-06-05")
# storeH10 <- scrape_statcast_savant_batter_all(start_date = "2015-06-06", end_date = "2015-06-14")
# storeH11 <- scrape_statcast_savant_batter_all(start_date = "2015-06-15", end_date = "2015-06-23")
# storeH12 <- scrape_statcast_savant_batter_all(start_date = "2015-06-24", end_date = "2015-07-01")
# storeH13 <- scrape_statcast_savant_batter_all(start_date = "2015-07-02", end_date = "2015-07-11")
# storeH14 <- scrape_statcast_savant_batter_all(start_date = "2015-07-12", end_date = "2015-07-20")
# storeH15 <- scrape_statcast_savant_batter_all(start_date = "2015-07-21", end_date = "2015-07-29")
# storeH16 <- scrape_statcast_savant_batter_all(start_date = "2015-07-30", end_date = "2015-08-05")
# storeH17 <- scrape_statcast_savant_batter_all(start_date = "2015-08-06", end_date = "2015-08-14")
# storeH18 <- scrape_statcast_savant_batter_all(start_date = "2015-08-15", end_date = "2015-08-23")
# storeH19 <- scrape_statcast_savant_batter_all(start_date = "2015-08-24", end_date = "2015-09-01")
# storeH20 <- scrape_statcast_savant_batter_all(start_date = "2015-09-02", end_date = "2015-09-10")
# storeH21 <- scrape_statcast_savant_batter_all(start_date = "2015-09-11", end_date = "2015-09-19")
# storeH22 <- scrape_statcast_savant_batter_all(start_date = "2015-09-20", end_date = "2015-09-28")
# storeH23 <- scrape_statcast_savant_batter_all(start_date = "2015-09-29", end_date = "2015-10-05")
#
#  all_pitches15 <- rbind(storeH2, storeH3, storeH4, storeH5, storeH6, storeH7, storeH8,
#                      storeH9, storeH10, storeH11, storeH12, storeH13, storeH14,
#                       storeH15, storeH16, storeH17, storeH18, storeH19, storeH20,
#                       storeH21, storeH22, storeH23)
#
# #Saving the very large dataset so I won't need to run the above code again
#  save(all_pitches15, file = "data/SavantPitch15.rda")
```
```{r eval=FALSE, include=FALSE}
#  load("data/SavantPitch19.rda")
# load("data/SavantPitch18.rda")
# load("data/SavantPitch17.rda")
# load("data/SavantPitch16.rda")
# load("data/SavantPitch15.rda")
```
```{r eval=FALSE, include=FALSE}
# pitchers_2015 <- all_pitches15 %>% select(pitcher,  release_pos_x,release_pos_z,release_spin_rate,release_speed,pitch_type,pitch_name)
#
# pitchers_2016 <-all_pitches16 %>% select(pitcher,  release_pos_x,release_pos_z,release_spin_rate,release_speed,pitch_type,pitch_name)
#
# pitchers_2017 <- all_pitches17 %>% select(pitcher,  release_pos_x,release_pos_z,release_spin_rate,release_speed,pitch_type,pitch_name)
#
# pitchers_2018 <- all_pitches18 %>% select(pitcher,  release_pos_x,release_pos_z,release_spin_rate,release_speed,pitch_type,pitch_name)
#
# pitchers_2019 <- all_pitches19 %>% select(pitcher,  release_pos_x,release_pos_z,release_spin_rate,release_speed,pitch_type,pitch_name)
#
# all_pitchers <- rbind(pitchers_2015,pitchers_2016,pitchers_2017,pitchers_2018,pitchers_2019)
```
```{r eval=FALSE, include=FALSE}
# pitcher_info <- all_pitchers %>% group_by(pitcher, pitch_name,pitch_type) %>%
#   summarise(count = n(), release_speed = mean(release_speed, na.rm=TRUE), release_pos_z = mean(release_pos_z, na.rm=TRUE), release_pos_x = mean(release_pos_x, na.rm=TRUE),release_spin_rate= mean(release_spin_rate, na.rm=TRUE)) %>% filter(count >= 100)%>%drop_na()
#
# save(pitcher_info, file = "data/pitcher_info.rda")
```
```{r eval=FALSE, include=FALSE}
# all_pitches15 <- all_pitches15 %>%
#   filter(!is.na(events)) %>%
#   select(player_name, pitcher, batter, events) %>%
#   mutate(Result = ifelse(str_detect(events, "ball"), "ball", ifelse(str_detect(events, "strike")& !str_detect(events, "strikeout") | str_detect(events, "foul"), "strike", ifelse(str_detect(events, "single"), "single", ifelse(str_detect(events, "double"), "double", ifelse(str_detect(events, "triple"), "triple", ifelse(str_detect(events, "home_run"), "home run", ifelse(str_detect(events, "out")|str_detect(events, "error"), "out", "OTHER")))))))) %>% mutate(year = 2015)
#
# all_pitches16 <- all_pitches16 %>%
#   filter(!is.na(events)) %>%
#   select(player_name, pitcher, batter, events) %>%
#   mutate(Result = ifelse(str_detect(events, "ball"), "ball", ifelse(str_detect(events, "strike")& !str_detect(events, "strikeout") | str_detect(events, "foul"), "strike", ifelse(str_detect(events, "single"), "single", ifelse(str_detect(events, "double"), "double", ifelse(str_detect(events, "triple"), "triple", ifelse(str_detect(events, "home_run"), "home run", ifelse(str_detect(events, "out")|str_detect(events, "error"), "out", "OTHER"))))))))%>% mutate(year = 2016)
#
# all_pitches17 <- all_pitches17 %>%
#   filter(!is.na(events)) %>%
#   select(player_name, pitcher, batter, events) %>%
#   mutate(Result = ifelse(str_detect(events, "ball"), "ball", ifelse(str_detect(events, "strike")& !str_detect(events, "strikeout") | str_detect(events, "foul"), "strike", ifelse(str_detect(events, "single"), "single", ifelse(str_detect(events, "double"), "double", ifelse(str_detect(events, "triple"), "triple", ifelse(str_detect(events, "home_run"), "home run", ifelse(str_detect(events, "out")|str_detect(events, "error"), "out", "OTHER"))))))))%>% mutate(year = 2017)
#
# all_pitches18 <- all_pitches18 %>%
#   filter(!is.na(events)) %>%
#   select(player_name, pitcher, batter, events) %>%
#   mutate(Result = ifelse(str_detect(events, "ball"), "ball", ifelse(str_detect(events, "strike")& !str_detect(events, "strikeout") | str_detect(events, "foul"), "strike", ifelse(str_detect(events, "single"), "single", ifelse(str_detect(events, "double"), "double", ifelse(str_detect(events, "triple"), "triple", ifelse(str_detect(events, "home_run"), "home run", ifelse(str_detect(events, "out")|str_detect(events, "error"), "out", "OTHER"))))))))%>% mutate(year = 2018)
#
# all_pitches19 <- all_pitches19 %>%
#   filter(!is.na(events)) %>%
#   select(player_name, pitcher, batter, events) %>%
#   mutate(Result = ifelse(str_detect(events, "ball"), "ball", ifelse(str_detect(events, "strike")& !str_detect(events, "strikeout") | str_detect(events, "foul"), "strike", ifelse(str_detect(events, "single"), "single", ifelse(str_detect(events, "double"), "double", ifelse(str_detect(events, "triple"), "triple", ifelse(str_detect(events, "home_run"), "home run", ifelse(str_detect(events, "out")|str_detect(events, "error"), "out", "OTHER"))))))))%>% mutate(year = 2019)
#
# all_pitches <- rbind(all_pitches15,all_pitches16,all_pitches17,all_pitches18,all_pitches19)
# save(all_pitches, file = "data/allPitches.rda")
```

```{r eval=FALSE, include=FALSE}

# load("data/pitcher_info.rda")
#
# pitcher_info <- pitcher_info %>%
#   select(-pitch_type)
#
# table(pitcher_info$pitch_name)
#
# pitcher_info <- pitcher_info %>%
#   filter(pitch_name != "Eephus" & pitch_name != "Fastball" & pitch_name != "Forkball" & pitch_name != "Knuckleball" & pitch_name != "Screwball") %>%
#   filter(pitcher != 607560) # This pitcher is screwing things up
#
# pitcher_info <- pitcher_info %>%
#   mutate(extension = ifelse(release_pos_x > 0, sqrt(release_pos_x^2 + release_pos_z^2), -sqrt(release_pos_x^2 + release_pos_z^2))) %>%
#   select(-release_pos_x, -release_pos_z)
#
# pitcher_pivoted <- pitcher_info %>%
#   group_by(pitcher) %>%
#   mutate(row = row_number()) %>%
#   tidyr::pivot_wider(id_cols = pitcher, names_from = pitch_name, values_from = count:extension)
#
# pitcher_pivoted[is.na(pitcher_pivoted)] <- 0
#
# names(pitcher_pivoted) <- janitor::make_clean_names(names(pitcher_pivoted))
```

```{r eval=FALSE, include=FALSE}
#  pitcher_pivoted <- pitcher_pivoted %>% rowwise() %>% mutate(
#   total_pitches =
#       count_2_seam_fastball +
#       count_4_seam_fastball +
#       count_changeup +
#       count_slider +
#       count_sinker +
#       count_curveball +
#       count_cutter +
#       count_split_finger + count_knuckle_curve)
#
# final_pitcher_data <- pitcher_pivoted %>% mutate(
#     rate_knuckle_curve = count_knuckle_curve / total_pitches,
#   rate_2_seam_fastball = count_2_seam_fastball / total_pitches,
#   rate_4_seam_fastball = count_4_seam_fastball / total_pitches,
#   rate_4_changeup = count_changeup / total_pitches,
#   rate_slider = count_slider / total_pitches,
#   rate_sinker = count_sinker / total_pitches,
#   rate_curveball = count_curveball / total_pitches,
#   rate_cutter = count_cutter / total_pitches,
#   rate_split_finger = count_split_finger / total_pitches
# ) %>% select(-count_knuckle_curve,-count_2_seam_fastball,-count_4_seam_fastball,-count_changeup,-count_slider,-count_sinker,-count_sinker,-count_curveball,-count_cutter,-count_split_finger, -total_pitches)
#
# save(final_pitcher_data, file = "data/final_pitcher_data.rda")
```


```{r}
load("data/allPitches.rda")

load("data/final_pitcher_data.rda")
```


```{r}
ID_lookup <- baseballr::get_chadwick_lu() %>%
  filter(mlb_played_last >= 2015) %>%
  mutate(name = paste(name_first, name_last)) %>%
  select(name, key_mlbam)

```

```{r}
leader_BA <- scrape_savant_leaderboards(
  leaderboard = "expected_statistics",
  year = 2015,
  abs = 0,
  min_pa = 1,
  min_pitches = 100,
  min_field = "q",
  min_run = 0,
  player_type = "batter",
  fielding_type = "player",
  oaa_position = "",
  oaa_roles = "",
  team = "",
  arsenal_type = "n_",
  run_type = "raw",
  min2b = 0,
  min3b = 0,
  position = "",
  bats = "",
  hand = ""
)
```


```{r}
leader_BA_Pit <- scrape_savant_leaderboards(
  leaderboard = "expected_statistics",
  year = 2015,
  abs = 0,
  min_pa = 1,
  min_pitches = 100,
  min_field = "q",
  min_run = 0,
  player_type = "pitcher",
  fielding_type = "player",
  oaa_position = "",
  oaa_roles = "",
  team = "",
  arsenal_type = "n_",
  run_type = "raw",
  min2b = 0,
  min3b = 0,
  position = "",
  bats = "",
  hand = ""
)
```




# Creating Clusters
```{r}
fviz_nbclust(final_pitcher_data[c(2:37)], kmeans, method = "wss", k.max = 100) +
  ggtitle("How Many Clusters") +
    theme(text = element_text(size=4),
        axis.text.x = element_text(angle=90, hjust=1)) 
```

I will keep 27 clusters and use Ward's Method to determine my clusters. I will keep 43 clusters as there appears to be a plateau after 27.

```{r}
# Using Wards Method to Create my Clusters
kc.dist <- dist(scale(final_pitcher_data[c(2:37)]))
hcward <- hclust(kc.dist, method = "ward.D")
plot(hcward, cex = 0.7)
```
```{r}
library(ClusterR)
```



```{r}
# Extra Wrangling
wardSol <- (cutree(hcward, k = 43))

cluster_pitcher_data <- cbind(final_pitcher_data, wardSol)
(table(cluster_pitcher_data$wardSol))

cluster_pitcher_data <- left_join(cluster_pitcher_data, ID_lookup, by = c("pitcher" = "key_mlbam"))
```

```{r}


get_other_pitchers <- function(pitcherName, data = cluster_pitcher_data)
{
 justPitcherCluster <- (data%>%filter(name == pitcherName))$wardSol
 print(justPitcherCluster)
 
 otherPitchers <- (data%>%filter(wardSol == justPitcherCluster)%>%arrange(name))$name
 
 return(otherPitchers)
}
get_other_pitchers("Jacob deGrom")

cluster16 <- cluster_pitcher_data%>%filter(wardSol == 16)

getClusterPitchers <- function(cluster, data = cluster_pitcher_data)
{
  return((data%>%filter(wardSol == cluster))$name)
}
getClusterPitchers(25)
```

```{r}
library(rpart.plot)
library(rattle)
library(parsnip)
whichclass <- decision_tree(mode = "classification") %>%
set_engine("rpart", control = rpart.control(cp = 0.005, minbucket = 30)) %>%
fit(as.factor(wardSol) ~ ., data = cluster_pitcher_data%>%select(-pitcher,-name))
whichclass$fit$call <- rlang::call2("rpar::rpart", data = expr(sim_data))
prp(whichclass$fit)

rattle::fancyRpartPlot(whichclass$fit)
```


```{r}
clusterStats2 <- cluster_pitcher_data %>%
  select(2:27,38)%>% 
group_by(wardSol) %>%summarise_each(funs(mean(.[!is.na(.) & . != 0]))) 



clusterStats3 <- cluster_pitcher_data %>%
  select(28:38)%>% 
group_by(wardSol) %>%
summarise(across(everything(), mean),number_of_pitchers = n()) 

clusterStats <- left_join(clusterStats2, clusterStats3)
clusterStats[is.na(clusterStats)] = 0
```



```{r}
describeCluster <- function(cluster)
{
  thisCluster <- clusterStats %>% filter(wardSol == cluster)
frequentPitches <-c()
  occasionalPitches <- c()
  
  if(thisCluster$rate_sinker > .2)
  {
    frequentPitches[length(frequentPitches)+1] <- "sinker"
  }else if(thisCluster$rate_sinker > 0)
  {
    occasionalPitches[length(occasionalPitches)+1] <- "sinker"
  } 
  
   if(thisCluster$rate_split_finger > .2)
  {
    frequentPitches[length(frequentPitches)+1] <- "splitter"
  }else if(thisCluster$rate_split_finger > 0)
  {
    occasionalPitches[length(occasionalPitches)+1] <- "splitter"
  }  
  
  if(thisCluster$rate_4_changeup > .2)
  {
    frequentPitches[length(frequentPitches)+1] <- "changeup"
  }else if(thisCluster$rate_4_changeup > 0)
  {
    occasionalPitches[length(occasionalPitches)+1] <- "changeup"
  }  
  
  if(thisCluster$rate_4_seam_fastball > .2)
  {
    frequentPitches[length(frequentPitches)+1] <- "fastball"
  }else if(thisCluster$rate_4_seam_fastball > 0)
  {
    occasionalPitches[length(occasionalPitches)+1] <- "fastball"
  }  
  if(thisCluster$rate_2_seam_fastball > .2)
  {
    frequentPitches[length(frequentPitches)+1] <- "2-seam"
  }else if(thisCluster$rate_2_seam_fastball > 0)
  {
    occasionalPitches[length(occasionalPitches)+1] <- "2-seam"
  }  
  if(thisCluster$rate_curveball > .2)
  {
    frequentPitches[length(frequentPitches)+1] <- "curveball"
  }else if(thisCluster$rate_curveball > 0)
  {
    occasionalPitches[length(occasionalPitches)+1] <- "curveball"
  } 
 if(thisCluster$extension_knuckle_curve > .2)
  {
    frequentPitches[length(frequentPitches)+1] <- "knuckle curve"
  }else if(thisCluster$extension_knuckle_curve > 0)
  {
    occasionalPitches[length(occasionalPitches)+1] <- "knuckle curve"
  } 
   if(thisCluster$rate_slider > .2)
  {
    frequentPitches[length(frequentPitches)+1] <- "slider"
  }else if(thisCluster$rate_slider > 0)
  {
    occasionalPitches[length(occasionalPitches)+1] <- "slider"
  } 
   if(thisCluster$rate_cutter > .2)
  {
    frequentPitches[length(frequentPitches)+1] <- "cutter"
  }else if(thisCluster$rate_cutter > 0)
  {
    occasionalPitches[length(occasionalPitches)+1] <- "cutter"
  }
    
print(paste("Frequent Pitches of Cluster", cluster, ":") )
print(frequentPitches)    
print(paste("Occasional Pitches of Cluster", cluster, ":"))
print(occasionalPitches )   

if(thisCluster$extension_2_seam_fastball >= 0 & thisCluster$extension_4_seam_fastball >= 0 & thisCluster$extension_changeup >= 0 & thisCluster$extension_slider >= 0 & thisCluster$extension_sinker >= 0 & thisCluster$extension_knuckle_curve >= 0 & thisCluster$extension_curveball >= 0 & thisCluster$extension_cutter >= 0 & thisCluster$extension_split_finger >= 0)
{
  print(paste("Cluster", cluster, " is ALL LEFTY"))
} else if(thisCluster$extension_2_seam_fastball <= 0 & thisCluster$extension_4_seam_fastball <= 0 & thisCluster$extension_changeup <= 0 & thisCluster$extension_slider <= 0 & thisCluster$extension_sinker <= 0 & thisCluster$extension_knuckle_curve <= 0 & thisCluster$extension_curveball <= 0 & thisCluster$extension_cutter <= 0 & thisCluster$extension_split_finger <= 0) {
  print(paste("Cluster", cluster, " is ALL RIGHTY"))
}else
{
  print(paste("Cluster", cluster, " is MIXED"))
}
  
}

#colnames(thisCluster)
```

```{r}
cluster <- 1
while (cluster <= max(clusterStats$wardSol))
{
#  print(paste("Cluster to test:", cluster))
describeCluster(cluster)
  cluster <- cluster +1 
}
```




```{r}
leader_BA <- leader_BA %>% select(first_name, last_name, year, player_id, ba, pa)
combinedData <- left_join(all_pitches, leader_BA, by = c("batter" = "player_id"))
leader_BA_Pit <- leader_BA %>% select(first_name, last_name, year, player_id, ba, pa)
combinedData2 <- left_join(combinedData, leader_BA_Pit, by = c("pitcher" = "player_id"))


leader_with_cluster <- left_join(combinedData2, cluster_pitcher_data) %>% filter(!is.na(wardSol))  %>%
  filter(Result == "double" | Result == "triple" | Result == "home run" | Result == "out" | Result == "single") %>%
  mutate(isHit = ifelse(Result == "out", 0, 1))
```

\newpage


## Preliminary Analysis

### General Terms

While this is a study designed for a general audience, understanding some baseball terminology could be useful. A few terms/parts of the data that might be helpful to understand throughout the project. 

Fastball: A fastball is generally the most basic pitch in baseball. Fastballs are generally thrown the most and the fastest. 

Breaking Ball: A breaking ball is usually a pitch that moves the most in baseball. There are two main types: sliders and curveballs. Sliders are thrown faster and break less (more horizontal movement than vertical). Curveballs are thrown slower and have more vertical movement. 

Offspeed: Offspeed pitches are designed to look like fastballs but are thrown slower. This is meant to throw off a hitter's timing, so they swing too early. 

Spin Rate: Spin rate is a measure of how often a ball spins during the time it is thrown to the plate. Spin rate is generally a measure of the quality of a pitch.

Extension: Extension is the distance from the center of the pitching rubber that the pitcher releases the ball. For this data, I used the total x, z distance ($\sqrt{x^2+z^2}$) although if the x-coodrinate is negative I kept that to represent the difference between righties and lefties. In this situation a negative extension represents a right-handed pitcher.

Starter: A starter is a pitcher who pitches once every five days, but pitches the most in total quantity. 

Reliever: A reliever is a pitcher who pitches frequently but for less time (fewer innings). 

ERA: ERA, or Earned Run Average, is a measure of how many runs are allowed by a pitcher every nine innings. Lower is better. 

wOBA: wOBA, or weighted On Base Average is a measure of how many hits (weighted by type of hit) a piker gives up each plate appearance. Lower is better (for pitchers). 
Exit Velocity: Exit velocity is a measure of how hard the ball is hit on average. A harder hit ball is bad for the pitcher. 





```{r}
groupBatterPitcher <- leader_with_cluster %>%
  group_by(pitcher, batter) %>%
  summarise(P_AB = n())
groupBatterPitcherHits <- leader_with_cluster %>%
  group_by(batter, pitcher) %>%
  summarise(P_Hits = sum(isHit))

pitcherCombo <- inner_join(groupBatterPitcherHits, groupBatterPitcher)

all_info <- inner_join(leader_with_cluster, pitcherCombo)

groupBatterCluster <- all_info %>%
  group_by(batter, wardSol) %>%
  summarise(C_AB = n())
groupBatterClusterHits <- all_info %>%
  group_by(batter, wardSol) %>%
  summarise(C_Hits = sum(isHit))

clusterCombo <- inner_join(groupBatterClusterHits, groupBatterCluster)

all_info_cluster <- inner_join(all_info, clusterCombo)
```

# Cluster Modeling

```{r}
filteredData <- all_info_cluster %>%
  filter(P_AB > 5 & C_AB > 5) %>%
  drop_na()

options(scipen = 10000)

# so it doesn't know the result of this AB
filteredData <- filteredData %>%
  mutate(P_AB = P_AB - 1) %>%
  mutate(C_AB = C_AB - 1) %>%
  mutate(P_Hits = P_Hits - isHit) %>%
  mutate(C_Hits = C_Hits - isHit)

filteredData <- filteredData %>%
  mutate(P_AVG = P_Hits / P_AB) %>%
  mutate(C_AVG = C_Hits / C_AB)
simpleMod <- glm(isHit ~ ba.x + ba.y, data = filteredData, family = "binomial")
pitcherMod <- glm(isHit ~ ba.x + ba.y + P_AB * P_Hits:P_AVG, data = filteredData, family = "binomial")
pitcherMod
clusterMod <- glm(isHit ~ ba.x + ba.y + C_AB * C_Hits * C_AVG, data = filteredData, family = "binomial")
bothMod <- glm(isHit ~ ba.x + ba.y + C_AB * C_Hits * C_AVG + P_AB * P_Hits * P_AVG, data = filteredData, family = "binomial")
clusterMod
```


```{r}
anova(simpleMod, clusterMod, test = "LR")
anova(simpleMod, pitcherMod, test = "LR")
anova(clusterMod, bothMod, test = "LR")
```


```{r}
predicted_data <- filteredData %>%
  mutate(isHitP = predict(pitcherMod, filteredData, type = "response")) %>%
  mutate(isHitC = predict(clusterMod, filteredData, type = "response")) %>%
  mutate(isHitBoth = predict(bothMod, filteredData, type = "response")) 
``` 

```{r}
mean(predicted_data$isHit)
table(predicted_data$events)
table(predicted_data$events)
```


```{r}
set.seed(5)
testSamp <- sample(predicted_data, 5000)

sum(testSamp$isHit)
sum(testSamp$isHitC)
sum(testSamp$isHitP)
```

```{r}
c <- ggplot(predicted_data, aes(x = isHitC, fill = as.factor(isHit))) +
   geom_density(alpha=.4)  +
  xlim(.175, .4) +
  xlab("Predicted Batting Average Via Clustering") +
  scale_color_discrete(labels = c("Out", "Hit")) +
  labs(color = "Actual Result")
p <- ggplot(predicted_data, aes(x = isHitP, fill = as.factor(isHit))) +
  geom_density(alpha=.4) +
  xlim(.175, .4) +
  xlab("Predicted Batting Average Via Pitcher") +
  scale_color_discrete(labels = c("Out", "Hit")) +
  labs(color = "Actual Result")

cowplot::plot_grid(c,p)



rbind(describe(x = predicted_data$isHitP), describe(x = predicted_data$isHitC))
```